name: Deployment to PROD

on:
  push:
    branches:    
      - main

permissions:
  contents: write  # Grant permissions to push tags to the repository

jobs:
  Deploy-PROD:
    runs-on: ubuntu-latest

    steps:
      # Checkout the code
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Install utilities
        run: |
         pip install yq
         xq --version
      

      # Create server key file
      - name: Create server key file
        run: |
          openssl enc -nosalt -aes-256-cbc -d -in assets/server.key.enc -out assets/server.key -base64 -K "${{ secrets.DECRYPTION_KEY }}" -iv "${{ secrets.DECRYPTION_IV }}"

      # Ensure sfdx is added to PATH
      - name: Installing Salesforce CLI
        run: sudo npm install @salesforce/cli --global
      # Install SGD
      - name: Install SGD
        run: echo y | sf plugins install "sfdx-git-delta"

      # Authorization with DevHub
      - name: Authorize DevHub
        run: |
          sf org login jwt --clientid "${{ secrets.SF_CLIENT_ID }}" --username "${{ secrets.SF_CICD_USERNAME }}" --jwtkeyfile assets/server.key --instanceurl https://login.salesforce.com

      # Delta deploy
      - name: "Delta deploy"
        run: | 
          git fetch --tags
          LATEST_TAG=$(git tag --list "PROD/*" --sort=-v:refname | head -n 1)
          echo "Using $LATEST_TAG"
          sf sgd source delta --from $LATEST_TAG --output "." -i .forceignore
          echo "--- package.xml generated with added and modified metadata ---"
          cat package/package.xml
          echo
          if grep -q '<types>' ./package/package.xml;then
            echo
            echo "--- Apex Tests to be executed ---"
            export APEX_CLASSES=$(xq . < SpecifiedTest.xml | jq '.Package.types | [.] | flatten | map(select(.name=="ApexClass")) | .[] | .members | [.] | flatten | map(select(. | index("*") | not)) | unique | join(",")' -r)
            echo $APEX_CLASSES
            echo
            echo "--- Delta Deploy ---"
            if [ -z "$APEX_CLASSES" ]; then
              sf project deploy start -x package/package.xml -w 30 -o ${{ secrets.SF_CICD_USERNAME }}
              sf project deploy report --use-most-recent -o ${{ secrets.SF_CICD_USERNAME }} --wait 120
            else
              sf project deploy start -x package/package.xml -w 30 -l RunSpecifiedTests --tests "$APEX_CLASSES" -o ${{ secrets.SF_CICD_USERNAME }}
              sf project deploy report --use-most-recent -o ${{ secrets.SF_CICD_USERNAME }} --wait 120
            fi
          else
            echo "----No Changes Found Skipping the Deployment----"
          fi


      # Add Tag on Success
      - name: Tag and Push
        if: success()
        run: |
          # Fetch all tags
          git fetch --tags

          # Get the latest tag with prefix "PROD/" and increment it
          LATEST_TAG=$(git tag --list "PROD/*" --sort=-v:refname | head -n 1)
          if [ -z "$LATEST_TAG" ]; then
            TAG_NAME="PROD/1"
          else
            TAG_NUMBER=${LATEST_TAG#PROD/}
            TAG_NAME="PROD/$((TAG_NUMBER + 1))"
          fi

          echo "Creating new tag: $TAG_NAME"

          # Configure Git user and create the new tag
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Use the GITHUB_TOKEN to push the tag
          git tag -a "$TAG_NAME" -m "Deployed to PROD"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} "$TAG_NAME"
